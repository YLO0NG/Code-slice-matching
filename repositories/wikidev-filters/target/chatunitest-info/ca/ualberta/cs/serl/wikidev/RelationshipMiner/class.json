{
  "fullClassName": "ca.ualberta.cs.serl.wikidev.RelationshipMiner",
  "className": "RelationshipMiner",
  "index": 40,
  "modifier": "[public ]",
  "extend": "[]",
  "implement": "[]",
  "packageName": "ca.ualberta.cs.serl.wikidev",
  "packageDeclaration": "package ca.ualberta.cs.serl.wikidev;",
  "classSignature": "public class RelationshipMiner",
  "hasConstructor": true,
  "isPublic": true,
  "isInterface": false,
  "isAbstract": false,
  "imports": [
    "import java.io.BufferedWriter;",
    "import java.io.FileWriter;",
    "import java.io.IOException;",
    "import java.sql.SQLException;",
    "import java.util.ArrayList;",
    "import java.util.HashMap;",
    "import java.util.HashSet;",
    "import java.util.Map;",
    "import java.util.Set;",
    "import java.util.TreeMap;",
    "import ca.ualberta.cs.serl.wikidev.artifacts.ChangeSet;",
    "import ca.ualberta.cs.serl.wikidev.artifacts.Message;",
    "import ca.ualberta.cs.serl.wikidev.artifacts.IArtifact;",
    "import ca.ualberta.cs.serl.wikidev.artifacts.Ticket;",
    "import ca.ualberta.cs.serl.wikidev.artifacts.Wiki;",
    "import ca.ualberta.cs.serl.wikidev.artifacts.WikiRevision;",
    "import ca.ualberta.cs.serl.wikidev.clustering.MatrixOperator;"
  ],
  "fields": [
    "private Set<Project> projectsChanged;",
    "private Set<IArtifact> artifactsChanged;",
    "private Set<User> usersChanged;",
    "private IArtifact sourceArtifact;",
    "private Project project;",
    "private ArrayList<Document> documents;",
    "private ArrayList<IArtifact> artifacts;"
  ],
  "superClasses": [],
  "implementedTypes": [],
  "methodSigs": {
    "getProjectsChanged()": "0",
    "getArtifactsChanged()": "1",
    "getUsersChanged()": "2",
    "getRelationships()": "3",
    "getCosineDistance(IArtifact, IArtifact)": "4",
    "relateChangeSetToTicket(ChangeSet)": "5",
    "containsArtifact(User, IArtifact)": "6",
    "relateArtifacts(IArtifact, IArtifact, double, String)": "7",
    "notifyUsers(IArtifact, IArtifact)": "8",
    "getGenericRelationships(IArtifact)": "9",
    "mineRelationshipsFromText()": "10",
    "getSimilarityMap()": "11",
    "getSimilarityMatrix()": "12",
    "getDistanceMatrix()": "13",
    "printResults(int)": "14",
    "RelationshipMiner(ArrayList)": "15"
  },
  "methodsBrief": [
    "public Set<Project> getProjectsChanged(){}",
    "public Set<IArtifact> getArtifactsChanged(){}",
    "public Set<User> getUsersChanged(){}",
    "public void getRelationships() throws SQLException{}",
    "private double getCosineDistance(IArtifact artifact1, IArtifact artifact2){}",
    "public void relateChangeSetToTicket(ChangeSet changeset) throws SQLException{}",
    "private boolean containsArtifact(User user, IArtifact artifact){}",
    "private void relateArtifacts(IArtifact artifact1, IArtifact artifact2, double value, String word){}",
    "private void notifyUsers(IArtifact artifact1, IArtifact artifact2){}",
    "private void getGenericRelationships(IArtifact artifact){}",
    "public void mineRelationshipsFromText(){}",
    "public HashMap<IArtifact, HashMap<IArtifact, Double>> getSimilarityMap(){}",
    "public double[][] getSimilarityMatrix(){}",
    "public double[][] getDistanceMatrix(){}",
    "public void printResults(int project){}",
    "public RelationshipMiner(ArrayList<IArtifact> artifacts){}"
  ],
  "constructorSigs": [
    "RelationshipMiner(ArrayList)"
  ],
  "constructorBrief": [
    "public RelationshipMiner(ArrayList<IArtifact> artifacts){}"
  ],
  "getterSetterSigs": [
    "getProjectsChanged()",
    "getArtifactsChanged()",
    "getUsersChanged()",
    "getRelationships()",
    "getSimilarityMap()",
    "getSimilarityMatrix()",
    "getDistanceMatrix()"
  ],
  "getterSetterBrief": [
    "public Set<Project> getProjectsChanged(){}",
    "public Set<IArtifact> getArtifactsChanged(){}",
    "public Set<User> getUsersChanged(){}",
    "public void getRelationships() throws SQLException{}",
    "public HashMap<IArtifact, HashMap<IArtifact, Double>> getSimilarityMap(){}",
    "public double[][] getSimilarityMatrix(){}",
    "public double[][] getDistanceMatrix(){}"
  ],
  "constructorDeps": {},
  "compilationUnitCode": "package ca.ualberta.cs.serl.wikidev;\n\nimport java.io.BufferedWriter;\nimport java.io.FileWriter;\nimport java.io.IOException;\nimport java.sql.SQLException;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.HashSet;\nimport java.util.Map;\nimport java.util.Set;\nimport java.util.TreeMap;\nimport ca.ualberta.cs.serl.wikidev.artifacts.ChangeSet;\nimport ca.ualberta.cs.serl.wikidev.artifacts.Message;\nimport ca.ualberta.cs.serl.wikidev.artifacts.IArtifact;\nimport ca.ualberta.cs.serl.wikidev.artifacts.Ticket;\nimport ca.ualberta.cs.serl.wikidev.artifacts.Wiki;\nimport ca.ualberta.cs.serl.wikidev.artifacts.WikiRevision;\nimport ca.ualberta.cs.serl.wikidev.clustering.MatrixOperator;\n\n/**\n * @author   User\n */\npublic class RelationshipMiner {\n\n    /**\n     * @uml.property  name=\"projectsChanged\"\n     */\n    private Set<Project> projectsChanged;\n\n    /**\n     * @uml.property  name=\"artifactsChanged\"\n     * @uml.associationEnd  multiplicity=\"(0 -1)\" elementType=\"ca.ualberta.cs.serl.wikidev.artifacts.IArtifact\"\n     */\n    private Set<IArtifact> artifactsChanged;\n\n    /**\n     * @uml.property  name=\"usersChanged\"\n     * @uml.associationEnd  multiplicity=\"(0 -1)\" elementType=\"ca.ualberta.cs.serl.wikidev.User\"\n     */\n    private Set<User> usersChanged;\n\n    /**\n     * @uml.property  name=\"sourceArtifact\"\n     * @uml.associationEnd\n     */\n    private IArtifact sourceArtifact;\n\n    /**\n     * @uml.property  name=\"project\"\n     * @uml.associationEnd\n     */\n    private Project project;\n\n    /**\n     * @uml.property  name=\"documents\"\n     * @uml.associationEnd  multiplicity=\"(0 -1)\" elementType=\"ca.ualberta.cs.serl.wikidev.Document\"\n     */\n    private ArrayList<Document> documents;\n\n    /**\n     * @uml.property  name=\"changesets\"\n     */\n    // private ArrayList<ChangeSet> changesets;\n    /**\n     * @uml.property  name=\"artifacts\"\n     */\n    private ArrayList<IArtifact> artifacts;\n\n    public RelationshipMiner(ArrayList<IArtifact> artifacts) {\n        this.projectsChanged = new HashSet<Project>();\n        this.artifactsChanged = new HashSet<IArtifact>();\n        this.usersChanged = new HashSet<User>();\n        this.documents = new ArrayList<Document>();\n        this.artifacts = artifacts;\n    }\n\n    /**\n     * @return\n     * @uml.property  name=\"projectsChanged\"\n     */\n    public Set<Project> getProjectsChanged() {\n        return projectsChanged;\n    }\n\n    /**\n     * @return\n     * @uml.property  name=\"artifactsChanged\"\n     */\n    public Set<IArtifact> getArtifactsChanged() {\n        return artifactsChanged;\n    }\n\n    /**\n     * @return\n     * @uml.property  name=\"usersChanged\"\n     */\n    public Set<User> getUsersChanged() {\n        return usersChanged;\n    }\n\n    public void getRelationships() throws SQLException {\n        ArrayList<String> buffers = new ArrayList<String>();\n        for (IArtifact artifact : artifacts) {\n            if (artifact instanceof Ticket) {\n                TextParser parser = new TextParser();\n                Ticket ticket = (Ticket) artifact;\n                parser.parseTextInWords(ticket.getDesription().toLowerCase());\n                parser.parseTextInWords(ticket.getSummary().toLowerCase());\n                documents.add(new Document(parser.getWords(), ticket.toString()));\n                ticket.setDocument(new Document(parser.getWords(), ticket.toString()));\n            } else if (artifact instanceof ChangeSet) {\n                TextParser parser = new TextParser();\n                ChangeSet changeset = (ChangeSet) artifact;\n                // relateChangeSetToTicket(changeset);\n                parser.parseTextInWords(changeset.getComment().toLowerCase());\n                documents.add(new Document(parser.getWords(), changeset.toString()));\n                changeset.setDocument(new Document(parser.getWords(), changeset.toString()));\n            } else if (artifact instanceof Message) {\n                TextParser parser = new TextParser();\n                Message communication = (Message) artifact;\n                parser.parseTextInWords(communication.getSubject().toLowerCase());\n                parser.parseTextInWords(communication.getBody().toLowerCase());\n                documents.add(new Document(parser.getWords(), communication.toString()));\n                communication.setDocument(new Document(parser.getWords(), communication.toString()));\n            } else if (artifact instanceof Wiki) {\n                Wiki wiki = (Wiki) artifact;\n                TextParser parser = new TextParser();\n                String text = \"\";\n                for (WikiRevision revision : wiki.getRevisions()) {\n                    text += revision.getRev_text();\n                }\n                parser.parseTextInWords(text.toLowerCase());\n                documents.add(new Document(parser.getWords(), wiki.toString()));\n                wiki.setDocument(new Document(parser.getWords(), wiki.toString()));\n            }\n        }\n        for (IArtifact artifact : artifacts) {\n            if (artifact instanceof Ticket) {\n                TextParser parser = new TextParser(documents);\n                Ticket ticket = (Ticket) artifact;\n                parser.parseTextInWords(ticket.getDesription().toLowerCase());\n                parser.parseTextInWords(ticket.getSummary().toLowerCase());\n                ticket.getDocument().setTfidf(parser.calculateTFIDF());\n            } else if (artifact instanceof ChangeSet) {\n                TextParser parser = new TextParser(documents);\n                ChangeSet changeset = (ChangeSet) artifact;\n                parser.parseTextInWords(changeset.getComment().toLowerCase());\n                changeset.getDocument().setTfidf(parser.calculateTFIDF());\n            } else if (artifact instanceof Message) {\n                TextParser parser = new TextParser(documents);\n                Message communication = (Message) artifact;\n                parser.parseTextInWords(communication.getSubject().toLowerCase());\n                parser.parseTextInWords(communication.getBody().toLowerCase());\n                communication.getDocument().setTfidf(parser.calculateTFIDF());\n            } else if (artifact instanceof Wiki) {\n                Wiki wiki = (Wiki) artifact;\n                TextParser parser = new TextParser(documents);\n                String text = \"\";\n                for (WikiRevision revision : wiki.getRevisions()) {\n                    text += revision.getRev_text();\n                }\n                parser.parseTextInWords(text.toLowerCase());\n                wiki.getDocument().setTfidf(parser.calculateTFIDF());\n            }\n        }\n        for (IArtifact artifact : artifacts) {\n            System.out.println(\"Relationships: \" + artifact.toString());\n            sourceArtifact = artifact;\n            project = artifact.getProject();\n            getGenericRelationships(sourceArtifact);\n            if (sourceArtifact instanceof Ticket) {\n                TextParser parser = new TextParser(documents);\n                Ticket ticket = (Ticket) sourceArtifact;\n                parser.parseTextInWords(ticket.getDesription().toLowerCase());\n                buffers.add(ticket.getDesription().toLowerCase());\n                parser.parseTextInWords(ticket.getSummary().toLowerCase());\n                buffers.add(ticket.getSummary().toLowerCase());\n                mineRelationshipsFromText();\n                /*for(URL url : parser.getUrls()) {\n\t\t\t\t\tmineRelationshipsFromURL(url);\n\t\t\t\t}*/\n            } else if (sourceArtifact instanceof ChangeSet) {\n                TextParser parser = new TextParser(documents);\n                ChangeSet changeset = (ChangeSet) sourceArtifact;\n                // relateChangeSetToTicket(changeset);\n                parser.parseTextInWords(changeset.getComment().toLowerCase());\n                buffers.add(changeset.getComment().toLowerCase());\n                mineRelationshipsFromText();\n                /*for(URL url : parser.getUrls()) {\n\t\t\t\t\tmineRelationshipsFromURL(url);\n\t\t\t\t}*/\n            } else if (sourceArtifact instanceof Message) {\n                TextParser parser = new TextParser(documents);\n                Message communication = (Message) sourceArtifact;\n                parser.parseTextInWords(communication.getSubject().toLowerCase());\n                buffers.add(communication.getSubject().toLowerCase());\n                parser.parseTextInWords(communication.getBody().toLowerCase());\n                buffers.add(communication.getBody().toLowerCase());\n                mineRelationshipsFromText();\n                /*for(URL url : parser.getUrls()) {\n\t\t\t\t\tmineRelationshipsFromURL(url);\n\t\t\t\t}*/\n            } else if (sourceArtifact instanceof Wiki) {\n                Wiki wiki = (Wiki) sourceArtifact;\n                TextParser parser = new TextParser(documents);\n                String text = \"\";\n                for (WikiRevision revision : wiki.getRevisions()) {\n                    text += revision.getRev_text();\n                }\n                parser.parseTextInWords(text.toLowerCase());\n                buffers.add(text.toLowerCase());\n                mineRelationshipsFromText();\n            }\n        }\n        // saveResults(buffers, project.toString());\n        // System.out.println(\"done\");\n    }\n\n    private double getCosineDistance(IArtifact artifact1, IArtifact artifact2) {\n        TreeMap<String, Double> unified = new TreeMap<String, Double>();\n        unified.putAll(artifact1.getDocument().getTfidf());\n        unified.putAll(artifact2.getDocument().getTfidf());\n        int size = unified.keySet().size();\n        double[] vector1 = new double[size];\n        double[] vector2 = new double[size];\n        int index = -1;\n        for (String term : unified.keySet()) {\n            index++;\n            if (artifact1.getDocument().getTfidf().containsKey(term)) {\n                vector1[index] = artifact1.getDocument().getTfidf().get(term);\n            } else {\n                vector1[index] = 0;\n            }\n            if (artifact2.getDocument().getTfidf().containsKey(term)) {\n                vector2[index] = artifact2.getDocument().getTfidf().get(term);\n            } else {\n                vector2[index] = 0;\n            }\n        }\n        double sum = 0;\n        double norm1 = 0;\n        double norm2 = 0;\n        for (int i = 0; i < size; i++) {\n            sum += vector1[i] * vector2[i];\n            norm1 += Math.pow(vector1[i], 2);\n            norm2 += Math.pow(vector2[i], 2);\n        }\n        double dis = 1 - sum / (Math.sqrt(norm1) * Math.sqrt(norm2));\n        return dis;\n    }\n\n    /*private void saveResults(ArrayList<String> buffers, String filename) {\n\t\ttry {\n\t\t\tBufferedWriter out = new BufferedWriter(new FileWriter(\"C:\\\\Documents and Settings\\\\Marios Fokaefs\\\\Desktop\\\\wikidev-files\\\\\"+filename+\".txt\"));\n\t\t\tfor(String buffer : buffers) {\n\t\t\t\tout.write(buffer);\n\t\t\t\tout.newLine();\n\t\t\t}\n\t\t\tout.close();\n\t\t} catch (IOException e) {\n\t\t\te.printStackTrace();\n\t\t}\n\t}*/\n    /*public void mineRelationshipsFromURL(URL url) throws SQLException {\n\t\t\n\t\tString projectName = url.getProjectName();\n\t\tProject project = DataManager.getProjectByName(projectName);\n\t\tString entityType = url.getEntityType();\n\t\tIArtifact artifact = DataManager.getArtifactByURL(entityType, url.getUrl());\n\t\tproject.addRelatedArtifact(artifact);\n\t\tprojectsChanged.add(project);\n\t\trelateArtifacts(sourceArtifact, artifact);\n\t}*/\n    public void relateChangeSetToTicket(ChangeSet changeset) throws SQLException {\n        ArrayList<String> ids = new ArrayList<String>();\n        String comment = changeset.getComment();\n        String ticketid = \"\";\n        String pattern = \"[0-9]\";\n        for (int i = 0; i < comment.length(); i++) {\n            if (comment.charAt(i) == '#') {\n                int j = i + 1;\n                String ch = comment.substring(j, j + 1);\n                while (ch.matches(pattern)) {\n                    ticketid += ch;\n                    j++;\n                    if (j < comment.length()) {\n                        ch = comment.substring(j, j + 1);\n                    } else {\n                        break;\n                    }\n                }\n                ids.add(ticketid);\n                ticketid = \"\";\n            }\n        }\n        for (String ticket_id : ids) {\n            if (!ticket_id.equals(\"\")) {\n                int id = Integer.parseInt(ticket_id);\n                Project project = DataManager.getProjectByExternalSystem(changeset.getExternalSystemID());\n                Ticket ticket = DataManager.getTicketByDrID(project.getProjectID(), id);\n                if (ticket != null) {\n                    relateArtifacts(ticket, changeset, 0, \"<TicketReference>\");\n                }\n            }\n        }\n    }\n\n    /*private boolean containsArtifact(IArtifact artifact1, IArtifact artifact2) {\n\t\tif (!artifact1.equals(artifact2)) {\n\t\t\tif (!artifact1.getRelatedArtifacts().isEmpty()) {\n\t\t\t\tif (artifact1.getRelatedArtifacts().containsKey(artifact2)) {\n\t\t\t\t\tif (artifact1.getRelatedArtifacts().get(artifact2) == 0) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\treturn true;\n\t\t}\n\t}*/\n    private boolean containsArtifact(User user, IArtifact artifact) {\n        if (!user.getRelatedArtifacts().isEmpty()) {\n            if (user.getRelatedArtifacts().containsKey(artifact)) {\n                if (user.getRelatedArtifacts().get(artifact) == 0) {\n                    return true;\n                } else {\n                    return false;\n                }\n            } else {\n                return false;\n            }\n        } else {\n            return false;\n        }\n    }\n\n    private void relateArtifacts(IArtifact artifact1, IArtifact artifact2, double value, String word) {\n        artifact1.addDirectlyRelatedArtifact(artifact2, value, word);\n        artifactsChanged.add(artifact1);\n        notifyUsers(artifact1, artifact2);\n        artifact2.addDirectlyRelatedArtifact(artifact1, value, word);\n        artifactsChanged.add(artifact2);\n        notifyUsers(artifact2, artifact1);\n        // calculateTransitiveRelationship(artifact1, artifact2);\n    }\n\n    /*private void calculateTransitiveRelationship(IArtifact artifact1, IArtifact artifact2) {\n\t\tif(artifact1.getDirectlyRelatedArtifacts().containsKey(artifact2)) {\n\t\t\t\tfor(IArtifact artifact : artifact1.getDirectlyRelatedArtifacts().keySet()) {\n\t\t\t\t\tif(!artifact2.getDirectlyRelatedArtifacts().containsKey(artifact) && !artifact2.equals(artifact)) {\n\t\t\t\t\t\tartifact2.addIndirectlyRelatedArtifact(artifact, artifact1);\n\t\t\t\t\t\tartifactsChanged.add(artifact2);\n\t\t\t\t\t}\n\t\t\t\t\tif(!artifact.getDirectlyRelatedArtifacts().containsKey(artifact2) && !artifact.equals(artifact2)) {\n\t\t\t\t\t\tartifact.addIndirectlyRelatedArtifact(artifact2, artifact1);\n\t\t\t\t\t\tartifactsChanged.add(artifact);\n\t\t\t\t\t}\n\t\t\t\t\tnotifyUsers(artifact, artifact2);\n\t\t\t\t}\n\t\t}\n\t\tif(artifact2.getDirectlyRelatedArtifacts().containsKey(artifact1)) {\n\t\t\tfor(IArtifact artifact : artifact2.getDirectlyRelatedArtifacts().keySet()) {\n\t\t\t\tif(!artifact1.getDirectlyRelatedArtifacts().containsKey(artifact) && !artifact1.equals(artifact)) {\n\t\t\t\t\tartifact1.addIndirectlyRelatedArtifact(artifact, artifact2);\n\t\t\t\t\tartifactsChanged.add(artifact1);\n\t\t\t\t}\n\t\t\t\tif(!artifact.getDirectlyRelatedArtifacts().containsKey(artifact1) && !artifact.equals(artifact1)) {\n\t\t\t\t\tartifact.addIndirectlyRelatedArtifact(artifact1, artifact2);\n\t\t\t\t\tartifactsChanged.add(artifact);\n\t\t\t\t}\n\t\t\t\tnotifyUsers(artifact, artifact1);\n\t\t\t}\n\t\t}\n\t}*/\n    private void notifyUsers(IArtifact artifact1, IArtifact artifact2) {\n        for (User user : artifact1.getAssociatedUsers()) {\n            if (user != null) {\n                if (!containsArtifact(user, artifact2)) {\n                    user.addRelatedArtifacts(artifact2, 1);\n                    usersChanged.add(user);\n                }\n            }\n        }\n    }\n\n    private void getGenericRelationships(IArtifact artifact) {\n        for (User user : artifact.getAssociatedUsers()) {\n            if (user != null) {\n                if (!containsArtifact(user, artifact)) {\n                    user.addRelatedArtifacts(artifact, 0);\n                    usersChanged.add(user);\n                }\n            }\n        }\n        project.addRelatedArtifact(artifact);\n        projectsChanged.add(project);\n    }\n\n    public void mineRelationshipsFromText() {\n        Set<User> users = project.getUsers();\n        for (String word : sourceArtifact.getDocument().getTerms()) {\n            for (IArtifact artifact : artifacts) {\n                if (!sourceArtifact.equals(artifact)) {\n                    for (String word2 : artifact.getDocument().getTerms()) {\n                        if (Dictionary.matchesWord(word, word2)) {\n                            relateArtifacts(sourceArtifact, artifact, getCosineDistance(sourceArtifact, artifact), word);\n                        }\n                    }\n                }\n            }\n            /*if (!(sourceArtifact instanceof ChangeSet)) {\n\t\t\t\tfor (ChangeSet changeset : project.getChangesets()) {\n\t\t\t\t\tfor (ChangeSetDetail changesetdetail : changeset\n\t\t\t\t\t\t\t.getChangesetDetails()) {\n\t\t\t\t\t\tif (changesetdetail.getFile().endsWith(\"java\")) {\n\t\t\t\t\t\t\tif (Dictionary.matchesWord(word, changesetdetail\n\t\t\t\t\t\t\t\t\t.getFile())) {\n\t\t\t\t\t\t\t\trelateArtifacts(sourceArtifact, changeset, getCosineDistance(sourceArtifact, changeset), word);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}*/\n            for (User user : users) {\n                if (Dictionary.matchesPattern(word, Dictionary.getUnionPatternOfStrings(user.getAliases()))) {\n                    if (!containsArtifact(user, sourceArtifact)) {\n                        user.addRelatedArtifacts(sourceArtifact, 0);\n                        usersChanged.add(user);\n                    }\n                }\n            }\n        }\n    }\n\n    public HashMap<IArtifact, HashMap<IArtifact, Double>> getSimilarityMap() {\n        HashMap<IArtifact, HashMap<IArtifact, Double>> fullMap = new HashMap<IArtifact, HashMap<IArtifact, Double>>();\n        for (IArtifact artifact1 : artifacts) {\n            HashMap<IArtifact, Double> map = new HashMap<IArtifact, Double>();\n            for (IArtifact artifact2 : artifacts) {\n                if (artifact1.containsRelatedArtifact(artifact2)) {\n                    map.put(artifact2, artifact1.getRelatedArtifact(artifact2).getDistance());\n                } else {\n                    map.put(artifact2, 1.0);\n                }\n            }\n            fullMap.put(artifact1, map);\n        }\n        return fullMap;\n    }\n\n    public double[][] getSimilarityMatrix() {\n        int i = 0;\n        int j = 0;\n        HashMap<IArtifact, HashMap<IArtifact, Double>> similarityMap = getSimilarityMap();\n        double[][] matrix = new double[similarityMap.size()][similarityMap.size()];\n        for (IArtifact artifact : artifacts) {\n            Map<IArtifact, Double> similarities = similarityMap.get(artifact);\n            for (IArtifact artifact2 : artifacts) {\n                if (i == j) {\n                    matrix[i][j] = 0;\n                } else {\n                    matrix[i][j] = similarities.get(artifact2);\n                    matrix[j][i] = similarities.get(artifact2);\n                }\n                j++;\n            }\n            i++;\n            j = 0;\n        }\n        return matrix;\n    }\n\n    public double[][] getDistanceMatrix() {\n        double[][] distanceMatrix = getSimilarityMatrix();\n        for (int l = 0; l < 10; l++) {\n            for (int j = 0; j < distanceMatrix.length; j++) {\n                double[] vector = MatrixOperator.getColumn(distanceMatrix, j);\n                for (int i = 0; i < distanceMatrix.length; i++) {\n                    for (int k = i + 1; k < distanceMatrix.length; k++) {\n                        if (vector[i] != 0 && vector[k] != 0) {\n                            double value = vector[i] + vector[k];\n                            if (value < distanceMatrix[i][k]) {\n                                distanceMatrix[i][k] = value;\n                                distanceMatrix[k][i] = value;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        return distanceMatrix;\n    }\n\n    public void printResults(int project) {\n        double[][] distanceMatrix = getSimilarityMatrix();\n        try {\n            BufferedWriter out = new BufferedWriter(new FileWriter(\"C:\\\\Documents and Settings\\\\Marios Fokaefs\\\\Desktop\\\\wikidev-files\\\\ucosp\\\\results.txt\"));\n            out.write(\"x=c(\");\n            for (int i = 0; i < distanceMatrix.length; i++) {\n                for (int j = 0; j < distanceMatrix.length; j++) {\n                    out.write(distanceMatrix[i][j] + \", \");\n                }\n            }\n            out.write(\")\");\n            out.close();\n        } catch (IOException e) {\n            // TODO Auto-generated catch block\n            e.printStackTrace();\n        }\n    }\n}\n",
  "classDeclarationCode": "/**\n * @author   User\n */\npublic class RelationshipMiner {\n\n    /**\n     * @uml.property  name=\"projectsChanged\"\n     */\n    private Set<Project> projectsChanged;\n\n    /**\n     * @uml.property  name=\"artifactsChanged\"\n     * @uml.associationEnd  multiplicity=\"(0 -1)\" elementType=\"ca.ualberta.cs.serl.wikidev.artifacts.IArtifact\"\n     */\n    private Set<IArtifact> artifactsChanged;\n\n    /**\n     * @uml.property  name=\"usersChanged\"\n     * @uml.associationEnd  multiplicity=\"(0 -1)\" elementType=\"ca.ualberta.cs.serl.wikidev.User\"\n     */\n    private Set<User> usersChanged;\n\n    /**\n     * @uml.property  name=\"sourceArtifact\"\n     * @uml.associationEnd\n     */\n    private IArtifact sourceArtifact;\n\n    /**\n     * @uml.property  name=\"project\"\n     * @uml.associationEnd\n     */\n    private Project project;\n\n    /**\n     * @uml.property  name=\"documents\"\n     * @uml.associationEnd  multiplicity=\"(0 -1)\" elementType=\"ca.ualberta.cs.serl.wikidev.Document\"\n     */\n    private ArrayList<Document> documents;\n\n    /**\n     * @uml.property  name=\"changesets\"\n     */\n    // private ArrayList<ChangeSet> changesets;\n    /**\n     * @uml.property  name=\"artifacts\"\n     */\n    private ArrayList<IArtifact> artifacts;\n\n    public RelationshipMiner(ArrayList<IArtifact> artifacts) {\n        this.projectsChanged = new HashSet<Project>();\n        this.artifactsChanged = new HashSet<IArtifact>();\n        this.usersChanged = new HashSet<User>();\n        this.documents = new ArrayList<Document>();\n        this.artifacts = artifacts;\n    }\n\n    /**\n     * @return\n     * @uml.property  name=\"projectsChanged\"\n     */\n    public Set<Project> getProjectsChanged() {\n        return projectsChanged;\n    }\n\n    /**\n     * @return\n     * @uml.property  name=\"artifactsChanged\"\n     */\n    public Set<IArtifact> getArtifactsChanged() {\n        return artifactsChanged;\n    }\n\n    /**\n     * @return\n     * @uml.property  name=\"usersChanged\"\n     */\n    public Set<User> getUsersChanged() {\n        return usersChanged;\n    }\n\n    public void getRelationships() throws SQLException {\n        ArrayList<String> buffers = new ArrayList<String>();\n        for (IArtifact artifact : artifacts) {\n            if (artifact instanceof Ticket) {\n                TextParser parser = new TextParser();\n                Ticket ticket = (Ticket) artifact;\n                parser.parseTextInWords(ticket.getDesription().toLowerCase());\n                parser.parseTextInWords(ticket.getSummary().toLowerCase());\n                documents.add(new Document(parser.getWords(), ticket.toString()));\n                ticket.setDocument(new Document(parser.getWords(), ticket.toString()));\n            } else if (artifact instanceof ChangeSet) {\n                TextParser parser = new TextParser();\n                ChangeSet changeset = (ChangeSet) artifact;\n                // relateChangeSetToTicket(changeset);\n                parser.parseTextInWords(changeset.getComment().toLowerCase());\n                documents.add(new Document(parser.getWords(), changeset.toString()));\n                changeset.setDocument(new Document(parser.getWords(), changeset.toString()));\n            } else if (artifact instanceof Message) {\n                TextParser parser = new TextParser();\n                Message communication = (Message) artifact;\n                parser.parseTextInWords(communication.getSubject().toLowerCase());\n                parser.parseTextInWords(communication.getBody().toLowerCase());\n                documents.add(new Document(parser.getWords(), communication.toString()));\n                communication.setDocument(new Document(parser.getWords(), communication.toString()));\n            } else if (artifact instanceof Wiki) {\n                Wiki wiki = (Wiki) artifact;\n                TextParser parser = new TextParser();\n                String text = \"\";\n                for (WikiRevision revision : wiki.getRevisions()) {\n                    text += revision.getRev_text();\n                }\n                parser.parseTextInWords(text.toLowerCase());\n                documents.add(new Document(parser.getWords(), wiki.toString()));\n                wiki.setDocument(new Document(parser.getWords(), wiki.toString()));\n            }\n        }\n        for (IArtifact artifact : artifacts) {\n            if (artifact instanceof Ticket) {\n                TextParser parser = new TextParser(documents);\n                Ticket ticket = (Ticket) artifact;\n                parser.parseTextInWords(ticket.getDesription().toLowerCase());\n                parser.parseTextInWords(ticket.getSummary().toLowerCase());\n                ticket.getDocument().setTfidf(parser.calculateTFIDF());\n            } else if (artifact instanceof ChangeSet) {\n                TextParser parser = new TextParser(documents);\n                ChangeSet changeset = (ChangeSet) artifact;\n                parser.parseTextInWords(changeset.getComment().toLowerCase());\n                changeset.getDocument().setTfidf(parser.calculateTFIDF());\n            } else if (artifact instanceof Message) {\n                TextParser parser = new TextParser(documents);\n                Message communication = (Message) artifact;\n                parser.parseTextInWords(communication.getSubject().toLowerCase());\n                parser.parseTextInWords(communication.getBody().toLowerCase());\n                communication.getDocument().setTfidf(parser.calculateTFIDF());\n            } else if (artifact instanceof Wiki) {\n                Wiki wiki = (Wiki) artifact;\n                TextParser parser = new TextParser(documents);\n                String text = \"\";\n                for (WikiRevision revision : wiki.getRevisions()) {\n                    text += revision.getRev_text();\n                }\n                parser.parseTextInWords(text.toLowerCase());\n                wiki.getDocument().setTfidf(parser.calculateTFIDF());\n            }\n        }\n        for (IArtifact artifact : artifacts) {\n            System.out.println(\"Relationships: \" + artifact.toString());\n            sourceArtifact = artifact;\n            project = artifact.getProject();\n            getGenericRelationships(sourceArtifact);\n            if (sourceArtifact instanceof Ticket) {\n                TextParser parser = new TextParser(documents);\n                Ticket ticket = (Ticket) sourceArtifact;\n                parser.parseTextInWords(ticket.getDesription().toLowerCase());\n                buffers.add(ticket.getDesription().toLowerCase());\n                parser.parseTextInWords(ticket.getSummary().toLowerCase());\n                buffers.add(ticket.getSummary().toLowerCase());\n                mineRelationshipsFromText();\n                /*for(URL url : parser.getUrls()) {\n\t\t\t\t\tmineRelationshipsFromURL(url);\n\t\t\t\t}*/\n            } else if (sourceArtifact instanceof ChangeSet) {\n                TextParser parser = new TextParser(documents);\n                ChangeSet changeset = (ChangeSet) sourceArtifact;\n                // relateChangeSetToTicket(changeset);\n                parser.parseTextInWords(changeset.getComment().toLowerCase());\n                buffers.add(changeset.getComment().toLowerCase());\n                mineRelationshipsFromText();\n                /*for(URL url : parser.getUrls()) {\n\t\t\t\t\tmineRelationshipsFromURL(url);\n\t\t\t\t}*/\n            } else if (sourceArtifact instanceof Message) {\n                TextParser parser = new TextParser(documents);\n                Message communication = (Message) sourceArtifact;\n                parser.parseTextInWords(communication.getSubject().toLowerCase());\n                buffers.add(communication.getSubject().toLowerCase());\n                parser.parseTextInWords(communication.getBody().toLowerCase());\n                buffers.add(communication.getBody().toLowerCase());\n                mineRelationshipsFromText();\n                /*for(URL url : parser.getUrls()) {\n\t\t\t\t\tmineRelationshipsFromURL(url);\n\t\t\t\t}*/\n            } else if (sourceArtifact instanceof Wiki) {\n                Wiki wiki = (Wiki) sourceArtifact;\n                TextParser parser = new TextParser(documents);\n                String text = \"\";\n                for (WikiRevision revision : wiki.getRevisions()) {\n                    text += revision.getRev_text();\n                }\n                parser.parseTextInWords(text.toLowerCase());\n                buffers.add(text.toLowerCase());\n                mineRelationshipsFromText();\n            }\n        }\n        // saveResults(buffers, project.toString());\n        // System.out.println(\"done\");\n    }\n\n    private double getCosineDistance(IArtifact artifact1, IArtifact artifact2) {\n        TreeMap<String, Double> unified = new TreeMap<String, Double>();\n        unified.putAll(artifact1.getDocument().getTfidf());\n        unified.putAll(artifact2.getDocument().getTfidf());\n        int size = unified.keySet().size();\n        double[] vector1 = new double[size];\n        double[] vector2 = new double[size];\n        int index = -1;\n        for (String term : unified.keySet()) {\n            index++;\n            if (artifact1.getDocument().getTfidf().containsKey(term)) {\n                vector1[index] = artifact1.getDocument().getTfidf().get(term);\n            } else {\n                vector1[index] = 0;\n            }\n            if (artifact2.getDocument().getTfidf().containsKey(term)) {\n                vector2[index] = artifact2.getDocument().getTfidf().get(term);\n            } else {\n                vector2[index] = 0;\n            }\n        }\n        double sum = 0;\n        double norm1 = 0;\n        double norm2 = 0;\n        for (int i = 0; i < size; i++) {\n            sum += vector1[i] * vector2[i];\n            norm1 += Math.pow(vector1[i], 2);\n            norm2 += Math.pow(vector2[i], 2);\n        }\n        double dis = 1 - sum / (Math.sqrt(norm1) * Math.sqrt(norm2));\n        return dis;\n    }\n\n    /*private void saveResults(ArrayList<String> buffers, String filename) {\n\t\ttry {\n\t\t\tBufferedWriter out = new BufferedWriter(new FileWriter(\"C:\\\\Documents and Settings\\\\Marios Fokaefs\\\\Desktop\\\\wikidev-files\\\\\"+filename+\".txt\"));\n\t\t\tfor(String buffer : buffers) {\n\t\t\t\tout.write(buffer);\n\t\t\t\tout.newLine();\n\t\t\t}\n\t\t\tout.close();\n\t\t} catch (IOException e) {\n\t\t\te.printStackTrace();\n\t\t}\n\t}*/\n    /*public void mineRelationshipsFromURL(URL url) throws SQLException {\n\t\t\n\t\tString projectName = url.getProjectName();\n\t\tProject project = DataManager.getProjectByName(projectName);\n\t\tString entityType = url.getEntityType();\n\t\tIArtifact artifact = DataManager.getArtifactByURL(entityType, url.getUrl());\n\t\tproject.addRelatedArtifact(artifact);\n\t\tprojectsChanged.add(project);\n\t\trelateArtifacts(sourceArtifact, artifact);\n\t}*/\n    public void relateChangeSetToTicket(ChangeSet changeset) throws SQLException {\n        ArrayList<String> ids = new ArrayList<String>();\n        String comment = changeset.getComment();\n        String ticketid = \"\";\n        String pattern = \"[0-9]\";\n        for (int i = 0; i < comment.length(); i++) {\n            if (comment.charAt(i) == '#') {\n                int j = i + 1;\n                String ch = comment.substring(j, j + 1);\n                while (ch.matches(pattern)) {\n                    ticketid += ch;\n                    j++;\n                    if (j < comment.length()) {\n                        ch = comment.substring(j, j + 1);\n                    } else {\n                        break;\n                    }\n                }\n                ids.add(ticketid);\n                ticketid = \"\";\n            }\n        }\n        for (String ticket_id : ids) {\n            if (!ticket_id.equals(\"\")) {\n                int id = Integer.parseInt(ticket_id);\n                Project project = DataManager.getProjectByExternalSystem(changeset.getExternalSystemID());\n                Ticket ticket = DataManager.getTicketByDrID(project.getProjectID(), id);\n                if (ticket != null) {\n                    relateArtifacts(ticket, changeset, 0, \"<TicketReference>\");\n                }\n            }\n        }\n    }\n\n    /*private boolean containsArtifact(IArtifact artifact1, IArtifact artifact2) {\n\t\tif (!artifact1.equals(artifact2)) {\n\t\t\tif (!artifact1.getRelatedArtifacts().isEmpty()) {\n\t\t\t\tif (artifact1.getRelatedArtifacts().containsKey(artifact2)) {\n\t\t\t\t\tif (artifact1.getRelatedArtifacts().get(artifact2) == 0) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\treturn true;\n\t\t}\n\t}*/\n    private boolean containsArtifact(User user, IArtifact artifact) {\n        if (!user.getRelatedArtifacts().isEmpty()) {\n            if (user.getRelatedArtifacts().containsKey(artifact)) {\n                if (user.getRelatedArtifacts().get(artifact) == 0) {\n                    return true;\n                } else {\n                    return false;\n                }\n            } else {\n                return false;\n            }\n        } else {\n            return false;\n        }\n    }\n\n    private void relateArtifacts(IArtifact artifact1, IArtifact artifact2, double value, String word) {\n        artifact1.addDirectlyRelatedArtifact(artifact2, value, word);\n        artifactsChanged.add(artifact1);\n        notifyUsers(artifact1, artifact2);\n        artifact2.addDirectlyRelatedArtifact(artifact1, value, word);\n        artifactsChanged.add(artifact2);\n        notifyUsers(artifact2, artifact1);\n        // calculateTransitiveRelationship(artifact1, artifact2);\n    }\n\n    /*private void calculateTransitiveRelationship(IArtifact artifact1, IArtifact artifact2) {\n\t\tif(artifact1.getDirectlyRelatedArtifacts().containsKey(artifact2)) {\n\t\t\t\tfor(IArtifact artifact : artifact1.getDirectlyRelatedArtifacts().keySet()) {\n\t\t\t\t\tif(!artifact2.getDirectlyRelatedArtifacts().containsKey(artifact) && !artifact2.equals(artifact)) {\n\t\t\t\t\t\tartifact2.addIndirectlyRelatedArtifact(artifact, artifact1);\n\t\t\t\t\t\tartifactsChanged.add(artifact2);\n\t\t\t\t\t}\n\t\t\t\t\tif(!artifact.getDirectlyRelatedArtifacts().containsKey(artifact2) && !artifact.equals(artifact2)) {\n\t\t\t\t\t\tartifact.addIndirectlyRelatedArtifact(artifact2, artifact1);\n\t\t\t\t\t\tartifactsChanged.add(artifact);\n\t\t\t\t\t}\n\t\t\t\t\tnotifyUsers(artifact, artifact2);\n\t\t\t\t}\n\t\t}\n\t\tif(artifact2.getDirectlyRelatedArtifacts().containsKey(artifact1)) {\n\t\t\tfor(IArtifact artifact : artifact2.getDirectlyRelatedArtifacts().keySet()) {\n\t\t\t\tif(!artifact1.getDirectlyRelatedArtifacts().containsKey(artifact) && !artifact1.equals(artifact)) {\n\t\t\t\t\tartifact1.addIndirectlyRelatedArtifact(artifact, artifact2);\n\t\t\t\t\tartifactsChanged.add(artifact1);\n\t\t\t\t}\n\t\t\t\tif(!artifact.getDirectlyRelatedArtifacts().containsKey(artifact1) && !artifact.equals(artifact1)) {\n\t\t\t\t\tartifact.addIndirectlyRelatedArtifact(artifact1, artifact2);\n\t\t\t\t\tartifactsChanged.add(artifact);\n\t\t\t\t}\n\t\t\t\tnotifyUsers(artifact, artifact1);\n\t\t\t}\n\t\t}\n\t}*/\n    private void notifyUsers(IArtifact artifact1, IArtifact artifact2) {\n        for (User user : artifact1.getAssociatedUsers()) {\n            if (user != null) {\n                if (!containsArtifact(user, artifact2)) {\n                    user.addRelatedArtifacts(artifact2, 1);\n                    usersChanged.add(user);\n                }\n            }\n        }\n    }\n\n    private void getGenericRelationships(IArtifact artifact) {\n        for (User user : artifact.getAssociatedUsers()) {\n            if (user != null) {\n                if (!containsArtifact(user, artifact)) {\n                    user.addRelatedArtifacts(artifact, 0);\n                    usersChanged.add(user);\n                }\n            }\n        }\n        project.addRelatedArtifact(artifact);\n        projectsChanged.add(project);\n    }\n\n    public void mineRelationshipsFromText() {\n        Set<User> users = project.getUsers();\n        for (String word : sourceArtifact.getDocument().getTerms()) {\n            for (IArtifact artifact : artifacts) {\n                if (!sourceArtifact.equals(artifact)) {\n                    for (String word2 : artifact.getDocument().getTerms()) {\n                        if (Dictionary.matchesWord(word, word2)) {\n                            relateArtifacts(sourceArtifact, artifact, getCosineDistance(sourceArtifact, artifact), word);\n                        }\n                    }\n                }\n            }\n            /*if (!(sourceArtifact instanceof ChangeSet)) {\n\t\t\t\tfor (ChangeSet changeset : project.getChangesets()) {\n\t\t\t\t\tfor (ChangeSetDetail changesetdetail : changeset\n\t\t\t\t\t\t\t.getChangesetDetails()) {\n\t\t\t\t\t\tif (changesetdetail.getFile().endsWith(\"java\")) {\n\t\t\t\t\t\t\tif (Dictionary.matchesWord(word, changesetdetail\n\t\t\t\t\t\t\t\t\t.getFile())) {\n\t\t\t\t\t\t\t\trelateArtifacts(sourceArtifact, changeset, getCosineDistance(sourceArtifact, changeset), word);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}*/\n            for (User user : users) {\n                if (Dictionary.matchesPattern(word, Dictionary.getUnionPatternOfStrings(user.getAliases()))) {\n                    if (!containsArtifact(user, sourceArtifact)) {\n                        user.addRelatedArtifacts(sourceArtifact, 0);\n                        usersChanged.add(user);\n                    }\n                }\n            }\n        }\n    }\n\n    public HashMap<IArtifact, HashMap<IArtifact, Double>> getSimilarityMap() {\n        HashMap<IArtifact, HashMap<IArtifact, Double>> fullMap = new HashMap<IArtifact, HashMap<IArtifact, Double>>();\n        for (IArtifact artifact1 : artifacts) {\n            HashMap<IArtifact, Double> map = new HashMap<IArtifact, Double>();\n            for (IArtifact artifact2 : artifacts) {\n                if (artifact1.containsRelatedArtifact(artifact2)) {\n                    map.put(artifact2, artifact1.getRelatedArtifact(artifact2).getDistance());\n                } else {\n                    map.put(artifact2, 1.0);\n                }\n            }\n            fullMap.put(artifact1, map);\n        }\n        return fullMap;\n    }\n\n    public double[][] getSimilarityMatrix() {\n        int i = 0;\n        int j = 0;\n        HashMap<IArtifact, HashMap<IArtifact, Double>> similarityMap = getSimilarityMap();\n        double[][] matrix = new double[similarityMap.size()][similarityMap.size()];\n        for (IArtifact artifact : artifacts) {\n            Map<IArtifact, Double> similarities = similarityMap.get(artifact);\n            for (IArtifact artifact2 : artifacts) {\n                if (i == j) {\n                    matrix[i][j] = 0;\n                } else {\n                    matrix[i][j] = similarities.get(artifact2);\n                    matrix[j][i] = similarities.get(artifact2);\n                }\n                j++;\n            }\n            i++;\n            j = 0;\n        }\n        return matrix;\n    }\n\n    public double[][] getDistanceMatrix() {\n        double[][] distanceMatrix = getSimilarityMatrix();\n        for (int l = 0; l < 10; l++) {\n            for (int j = 0; j < distanceMatrix.length; j++) {\n                double[] vector = MatrixOperator.getColumn(distanceMatrix, j);\n                for (int i = 0; i < distanceMatrix.length; i++) {\n                    for (int k = i + 1; k < distanceMatrix.length; k++) {\n                        if (vector[i] != 0 && vector[k] != 0) {\n                            double value = vector[i] + vector[k];\n                            if (value < distanceMatrix[i][k]) {\n                                distanceMatrix[i][k] = value;\n                                distanceMatrix[k][i] = value;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        return distanceMatrix;\n    }\n\n    public void printResults(int project) {\n        double[][] distanceMatrix = getSimilarityMatrix();\n        try {\n            BufferedWriter out = new BufferedWriter(new FileWriter(\"C:\\\\Documents and Settings\\\\Marios Fokaefs\\\\Desktop\\\\wikidev-files\\\\ucosp\\\\results.txt\"));\n            out.write(\"x=c(\");\n            for (int i = 0; i < distanceMatrix.length; i++) {\n                for (int j = 0; j < distanceMatrix.length; j++) {\n                    out.write(distanceMatrix[i][j] + \", \");\n                }\n            }\n            out.write(\")\");\n            out.close();\n        } catch (IOException e) {\n            // TODO Auto-generated catch block\n            e.printStackTrace();\n        }\n    }\n}",
  "subClasses": []
}